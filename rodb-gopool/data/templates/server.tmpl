{{/* Server info page template (formerly admin.html) */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} — Server Stats</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<main class="page" id="content">
		<noscript>
			<div class="card">
				<p class="text-sm" style="color:#f88d8d;margin:0;">
					JavaScript is required to load server stats on this page. For a no-JS view, use <a class="mono" href="/api/server">/api/server</a>.
				</p>
			</div>
		</noscript>
		<h1>Server Stats</h1>

		<div class="card">
			<div class="label">Backend status</div>
			<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:8px;">
				<div>
					<div class="label">Bitcoin RPC</div>
					<div class="mono" id="server-rpc-status">--</div>
					<div class="text-sm" id="server-rpc-counts">disconnects: --, reconnects: --</div>
				</div>
				<div>
					<div class="label">Accounting</div>
					<div class="mono" id="server-accounting-status">--</div>
				</div>
				<div>
					<div class="label">Job feed errors</div>
					<div class="mono" id="server-job-feed-error">--</div>
				</div>
				<div>
					<div class="label">ZMQ feed</div>
					<div class="mono" id="server-zmq-status">--</div>
					<div class="text-sm" id="server-zmq-counts">disconnects: --, connects: --</div>
				</div>
				<div id="server-zmq-rawblock-row" style="display:none;">
					<div class="label">ZMQ raw block (time/bytes)</div>
					<div class="mono" id="server-zmq-rawblock">--</div>
				</div>
				<div id="server-zmq-block-tip-row" style="display:none;">
					<div class="label">ZMQ block tip</div>
					<div class="mono" id="server-zmq-block-tip">--</div>
				</div>
				<div id="server-zmq-block-diff-row" style="display:none;">
					<div class="label">ZMQ block difficulty</div>
					<div class="mono" id="server-zmq-block-diff">--</div>
				</div>
			</div>
		</div>

		<div class="card">
			<div class="label">Process stats</div>
			<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:8px;">
				<div>
					<div class="label">Server uptime</div>
					<div class="mono" id="server-uptime">--</div>
				</div>
				<div>
					<div class="label">Goroutines</div>
					<div class="mono" id="server-goroutines">--</div>
				</div>
				<div>
					<div class="label">Go heap (alloc/sys)</div>
					<div class="mono" id="server-go-heap">-- / --</div>
				</div>
				<div>
					<div class="label">Process RSS</div>
					<div class="mono" id="server-process-rss">--</div>
				</div>
				<div>
					<div class="label">Pool CPU use</div>
					<div class="mono" id="server-pool-cpu">--</div>
				</div>
				<div>
					<div class="label">System RAM</div>
					<div class="mono" id="server-ram">--</div>
				</div>
				<div>
					<div class="label">Total System load (1/5/15m)</div>
					<div class="mono" id="server-load">-- / -- / --</div>
				</div>
			</div>
		</div>

		<div class="card">
			<div class="label">JSON API endpoints</div>
			<ul class="list">
				<li><a class="mono" href="/api/overview">/api/overview</a> &mdash; cached overview data used by the main status UI</li>
				<li><a class="mono" href="/api/pool-page">/api/pool-page</a> &mdash; pool page specific data</li>
				<li><a class="mono" href="/api/node">/api/node</a> &mdash; Bitcoin node identity and sync status</li>
				<li><a class="mono" href="/api/server">/api/server</a> &mdash; server page data including process and system diagnostics</li>
				<li><a class="mono" href="/api/pool-hashrate">/api/pool-hashrate</a> &mdash; rolling pool hashrate samples for graphs</li>
				<li><a class="mono" href="/api/blocks">/api/blocks</a> &mdash; recent found blocks (censored)</li>
			</ul>
		</div>

		<div style="margin-top:16px;padding:8px;text-align:center;font-size:0.85em;color:#888;">
			<div class="mono" id="server-data-refreshed">Data loading...</div>
		</div>

	{{template "footer" .}}
</main>
<script>
	(function () {
		const REFRESH_INTERVAL = 10000;

		const uptimeEl = document.getElementById('server-uptime');
		const rpcStatusEl = document.getElementById('server-rpc-status');
		const rpcCountsEl = document.getElementById('server-rpc-counts');
		const accountingEl = document.getElementById('server-accounting-status');
		const jobFeedEl = document.getElementById('server-job-feed-error');
		const zmqStatusEl = document.getElementById('server-zmq-status');
		const zmqCountsEl = document.getElementById('server-zmq-counts');
		const zmqRawBlockEl = document.getElementById('server-zmq-rawblock');
		const zmqBlockTipEl = document.getElementById('server-zmq-block-tip');
		const zmqBlockDiffEl = document.getElementById('server-zmq-block-diff');
		const zmqRawBlockRowEl = document.getElementById('server-zmq-rawblock-row');
		const zmqBlockTipRowEl = document.getElementById('server-zmq-block-tip-row');
		const zmqBlockDiffRowEl = document.getElementById('server-zmq-block-diff-row');
		const goroutinesEl = document.getElementById('server-goroutines');
		const goHeapEl = document.getElementById('server-go-heap');
		const processRSSEl = document.getElementById('server-process-rss');
		const poolCPUEl = document.getElementById('server-pool-cpu');
		const ramEl = document.getElementById('server-ram');
		const loadEl = document.getElementById('server-load');

		function formatDuration(ns) {
			if (!ns) return '—';
			const seconds = Math.floor(ns / 1e9);
			const days = Math.floor(seconds / 86400);
			const hours = Math.floor((seconds % 86400) / 3600);
			const mins = Math.floor((seconds % 3600) / 60);
			const secs = seconds % 60;
			if (days > 0) return `${days}d ${hours}h ${mins}m`;
			if (hours > 0) return `${hours}h ${mins}m ${secs}s`;
			if (mins > 0) return `${mins}m ${secs}s`;
			return `${secs}s`;
		}

		function formatBytes(bytes) {
			if (bytes === undefined || bytes === null) {
				return '0 B';
			}
			let val = Number(bytes);
			if (isNaN(val) || val <= 0) {
				return '0 B';
			}
			const units = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
			let idx = 0;
			while (val >= 1024 && idx < units.length - 1) {
				val /= 1024;
				idx++;
			}
			return `${val.toFixed(2)} ${units[idx]}`;
		}

		function formatPercent(value) {
			if (value === undefined || value === null) {
				return '--';
			}
			return `${Number(value).toFixed(3)}%`;
		}

		function formatLoad(value) {
			if (value === undefined || value === null) {
				return '--';
			}
			return Number(value).toFixed(2);
		}

		function setRowVisibility(rowEl, visible) {
			if (!rowEl) return;
			rowEl.style.display = visible ? '' : 'none';
		}

		function updateStatusPage(data) {
			if (!data) return;
			if (uptimeEl && data.uptime) {
				uptimeEl.textContent = formatDuration(data.uptime);
			}
			if (rpcStatusEl) {
				rpcStatusEl.textContent = data.rpc_healthy ? 'OK' : (data.rpc_error ? 'Offline' : 'Offline');
			}
			if (rpcCountsEl) {
				const disconnects = data.rpc_disconnects ?? 0;
				const reconnects = data.rpc_reconnects ?? 0;
				rpcCountsEl.textContent = `disconnects: ${disconnects}, reconnects: ${reconnects}`;
			}
			if (accountingEl) {
				accountingEl.textContent = data.accounting_error ? `Error: ${data.accounting_error}` : 'OK';
			}
			if (jobFeedEl) {
				const rawHistory = data.job_feed?.error_history ?? [];
				if (rawHistory.length > 0) {
					const history = rawHistory.slice().reverse();
					const isEvent = (msg) => String(msg || '').trim().toLowerCase().startsWith('event:');
					const entries = history.map((msg, idx) => {
						const prefix = isEvent(msg) ? (idx === 0 ? 'Event' : 'Previous event') : (idx === 0 ? 'Error' : 'Previous');
						return `${prefix}: ${msg}`;
					});
					if (!isEvent(history[0]) && data.job_feed?.last_error && data.job_feed?.last_error_at) {
						entries[0] += ` (at ${data.job_feed.last_error_at})`;
					}
					jobFeedEl.textContent = entries.join(' | ');
				} else {
					jobFeedEl.textContent = 'None';
				}
			}
			if (zmqStatusEl) {
				zmqStatusEl.textContent = data.job_feed?.zmq_healthy ? 'OK' : 'Offline';
			}
			if (zmqCountsEl) {
				const disconnects = data.job_feed?.zmq_disconnects ?? 0;
				const reconnects = data.job_feed?.zmq_reconnects ?? 0;
				zmqCountsEl.textContent = `disconnects: ${disconnects}, connects: ${reconnects}`;
			}
			if (zmqRawBlockEl) {
				const rawBlockAt = data.job_feed?.last_raw_block_at;
				const rawBlockBytes = data.job_feed?.last_raw_block_bytes;
				const hasRawBlock = Boolean(rawBlockAt) || (typeof rawBlockBytes === 'number' && rawBlockBytes > 0);
				if (hasRawBlock) {
					zmqRawBlockEl.textContent = rawBlockBytes ? `${rawBlockAt} (${rawBlockBytes} B)` : (rawBlockAt || '--');
				} else {
					zmqRawBlockEl.textContent = '--';
				}
				setRowVisibility(zmqRawBlockRowEl, hasRawBlock);
			}
			if (zmqBlockTipEl) {
				const blockHeight = data.job_feed?.block_height;
				const blockTime = data.job_feed?.block_time;
				const blockHash = data.job_feed?.block_hash;
				const hasBlockTip = (typeof blockHeight === 'number' && blockHeight > 0) || Boolean(blockTime) || Boolean(blockHash);
				if (hasBlockTip) {
					const heightText = (typeof blockHeight === 'number' && blockHeight > 0) ? blockHeight : '--';
					const tipTime = blockTime || '--';
					const hash = blockHash || '--';
					zmqBlockTipEl.textContent = `${heightText} @ ${tipTime} (${hash})`;
				} else {
					zmqBlockTipEl.textContent = '--';
				}
				setRowVisibility(zmqBlockTipRowEl, hasBlockTip);
			}
			if (zmqBlockDiffEl) {
				const bits = data.job_feed?.block_bits;
				const diff = Number(data.job_feed?.block_difficulty);
				const hasBlockDiff = Boolean(bits) || (Number.isFinite(diff) && diff > 0);
				if (hasBlockDiff) {
					if (Number.isFinite(diff) && diff > 0) {
						zmqBlockDiffEl.textContent = `${diff.toFixed(2)} diff (bits ${bits || '--'})`;
					} else {
						zmqBlockDiffEl.textContent = `bits ${bits}`;
					}
				} else {
					zmqBlockDiffEl.textContent = '--';
				}
				setRowVisibility(zmqBlockDiffRowEl, hasBlockDiff);
			}
		}

		function updateDiagnostics(data) {
			if (!data) return;
			if (goroutinesEl) {
				goroutinesEl.textContent = data.process_goroutines ?? '--';
			}
			if (goHeapEl) {
				goHeapEl.textContent = `${formatBytes(data.go_mem_alloc_bytes)} / ${formatBytes(data.go_mem_sys_bytes)}`;
			}
			if (processRSSEl) {
				processRSSEl.textContent = formatBytes(data.process_rss_bytes);
			}
			if (poolCPUEl) {
				poolCPUEl.textContent = formatPercent(data.process_cpu_percent);
			}
			if (ramEl) {
				ramEl.textContent = formatBytes(data.system_mem_total_bytes);
			}
			if (loadEl) {
				loadEl.textContent = `${formatLoad(data.system_load1)} / ${formatLoad(data.system_load5)} / ${formatLoad(data.system_load15)}`;
			}
		}

		function formatUTCTimestamp(isoString) {
			if (!isoString) return 'Loading...';
			try {
				const date = new Date(isoString);
				return 'Data refreshed at ' + date.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
			} catch (e) {
				return 'Loading...';
			}
		}

		function fetchServerData() {
			fetch('/api/server')
				.then(response => {
					if (!response.ok) throw new Error('Network response was not ok');
					const updatedAt = response.headers.get('X-JSON-Updated-At');
					const dataRefreshedEl = document.getElementById('server-data-refreshed');
					if (dataRefreshedEl && updatedAt) {
						dataRefreshedEl.textContent = formatUTCTimestamp(updatedAt);
					}
					return response.json();
				})
				.then(data => {
					updateStatusPage(data);
					updateDiagnostics(data);
				})
				.catch(error => {
					console.error('Error fetching server data:', error);
				});
		}

		function refresh() {
			fetchServerData();
		}

		refresh();
		setInterval(refresh, REFRESH_INTERVAL);
	})();
</script>
</body>
</html>
