{{/* Admin control panel template */}}
{{define "restart-required"}}<span class="restart-required" title="Requires restart">↻</span>{{end}}
{{define "admin-nav"}}
<div class="admin-tabs">
	<a class="admin-tab {{if eq .AdminSection "settings"}}active{{end}}" href="/admin">Live settings</a>
	<a class="admin-tab {{if eq .AdminSection "miners"}}active{{end}}" href="/admin/miners">Connected miners</a>
	<a class="admin-tab {{if eq .AdminSection "logins"}}active{{end}}" href="/admin/logins">Saved logins</a>
</div>
{{end}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} Admin Control Panel</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<div class="page admin-page">
		<h1>Admin Control Panel</h1>
		<p class="text-sm" style="margin-top:4px;">
			This panel is not linked anywhere else and is hidden until you configure <span class="mono">data/config/admin.toml</span>.
			Keep the file private and only enable the panel on trusted networks.
		</p>

		{{if .AdminNotice}}
		<div class="card">
			<p class="text-sm">{{.AdminNotice}}</p>
		</div>
		{{end}}

		{{if not .AdminEnabled}}
		<div class="card">
			<p class="text-sm">
				The admin UI is disabled. Enable it by editing
				<span class="mono">{{.AdminConfigPath}}</span> and setting <span class="mono">enabled = true</span>.
				Change the default credentials before reloading the page.
			</p>
		</div>
		{{else if not .LoggedIn}}
		<div class="card">
			<div class="label">Sign in</div>
			{{if .AdminLoginError}}
			<p class="text-sm" style="color:#f88d8d;">{{.AdminLoginError}}</p>
			{{end}}
			<form method="post" action="/admin/login">
				<label class="label" for="admin-username">Username</label>
				<input id="admin-username" name="username" type="text" class="textfield" autocomplete="username" required>
				<label class="label" for="admin-password">Password</label>
				<input id="admin-password" name="password" type="password" class="textfield" autocomplete="current-password" required>
				<button class="btn" type="submit" style="margin-top:12px;">Unlock admin panel</button>
			</form>
		</div>
		{{else}}
		{{template "admin-nav" .}}
		<div class="card">
				<div class="label">Live settings</div>
				<p class="text-sm" style="margin:4px 0 10px 0;">
					This updates goPool's in-memory configuration immediately. Some settings (listeners, Stratum behavior) still require a reboot to fully take effect.
					Hover over field labels to see tooltips with extra detail. <span class="restart-required" title="Requires restart">↻</span> indicates a restart is required.
				</p>
				{{if .AdminApplyError}}
				<p class="text-sm" style="color:#f88d8d;">{{.AdminApplyError}}</p>
				{{end}}
			<form method="post" action="/admin/apply">
				<h3 style="margin:0 0 8px 0;">Branding</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="Shown across the status UI as the pool name.">Brand name</div>
						<input name="status_brand_name" type="text" class="textfield" value="{{.Settings.StatusBrandName}}">
					</div>
					<div>
						<div class="label" title="The hostname shown in the UI and used for copy/paste Stratum URLs (usually your public domain).">Brand domain</div>
						<input name="status_brand_domain" type="text" class="textfield" value="{{.Settings.StatusBrandDomain}}">
					</div>
					<div>
						<div class="label" title="Short one-line description shown on the overview page.">Tagline</div>
						<input name="status_tagline" type="text" class="textfield" value="{{.Settings.StatusTagline}}">
					</div>
					<div>
						<div class="label" title="Fiat currency code used for price conversions (e.g. usd, eur).">Fiat currency</div>
						<input name="fiat_currency" type="text" class="textfield" value="{{.Settings.FiatCurrency}}">
					</div>
					<div>
						<div class="label" title="Link shown in the header (optional).">GitHub URL</div>
						<input name="github_url" type="text" class="textfield" value="{{.Settings.GitHubURL}}">
					</div>
					<div>
						<div class="label" title="Link shown in the header (optional).">Discord URL</div>
						<input name="discord_url" type="text" class="textfield" value="{{.Settings.DiscordURL}}">
					</div>
					<div>
						<div class="label" title="Shown on the status UI (optional).">Server location</div>
						<input name="server_location" type="text" class="textfield" value="{{.Settings.ServerLocation}}">
					</div>
					<div>
						<div class="label" title="Canonical public URL used for redirects and cookies (include https:// and host). Leave blank to auto-detect.">status_public_url</div>
						<input name="status_public_url" type="text" class="textfield" value="{{.Settings.StatusPublicURL}}">
					</div>
				</div>

				<h3 style="margin:18px 0 8px 0;">Listeners</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="Stratum TCP listener for miners (requires restart to change).">pool_listen {{template "restart-required" .}}</div>
						<input name="pool_listen" type="text" class="textfield" value="{{.Settings.ListenAddr}}">
					</div>
					<div>
						<div class="label" title="Status UI HTTP listener. When TLS is enabled, HTTP redirects to HTTPS (requires restart to change).">status_listen (http) {{template "restart-required" .}}</div>
						<input name="status_listen" type="text" class="textfield" value="{{.Settings.StatusAddr}}">
					</div>
					<div>
						<div class="label" title="Status UI HTTPS listener (requires restart to change).">status_tls_listen (https) {{template "restart-required" .}}</div>
						<input name="status_tls_listen" type="text" class="textfield" value="{{.Settings.StatusTLSAddr}}">
					</div>
					<div>
						<div class="label" title="Optional Stratum TLS listener for miners that support TLS (requires restart to change).">stratum_tls_listen {{template "restart-required" .}}</div>
						<input name="stratum_tls_listen" type="text" class="textfield" value="{{.Settings.StratumTLSListen}}">
					</div>
				</div>

				<h3 style="margin:18px 0 8px 0;">Limits</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="Maximum simultaneous Stratum connections allowed (checked on accept; requires restart to take effect).">max_conns {{template "restart-required" .}}</div>
						<input name="max_conns" type="number" class="textfield" value="{{.Settings.MaxConns}}">
					</div>
					<div>
						<div class="label" title="When enabled, goPool auto-computes accept throttles from max_conns on startup (overrides explicit accept_* values; requires restart).">auto_accept_rate_limits {{template "restart-required" .}}</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="auto_accept_rate_limits" value="1" {{if .Settings.AutoAcceptRateLimits}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
					<div>
						<div class="label" title="Connection accept throttle (accepts/sec) for the initial restart/reconnect window (requires restart).">max_accepts_per_second {{template "restart-required" .}}</div>
						<input name="max_accepts_per_second" type="number" class="textfield" value="{{.Settings.MaxAcceptsPerSecond}}">
					</div>
					<div>
						<div class="label" title="Burst size for accept limiter (token bucket). Allows short spikes (requires restart).">max_accept_burst {{template "restart-required" .}}</div>
						<input name="max_accept_burst" type="number" class="textfield" value="{{.Settings.MaxAcceptBurst}}">
					</div>
					<div>
						<div class="label" title="Target seconds for all miners to reconnect after a restart (used for auto_accept_rate_limits).">accept_reconnect_window {{template "restart-required" .}}</div>
						<input name="accept_reconnect_window" type="number" class="textfield" value="{{.Settings.AcceptReconnectWindow}}">
					</div>
					<div>
						<div class="label" title="Initial burst window (seconds) after restart (used for auto_accept_rate_limits).">accept_burst_window {{template "restart-required" .}}</div>
						<input name="accept_burst_window" type="number" class="textfield" value="{{.Settings.AcceptBurstWindow}}">
					</div>
					<div>
						<div class="label" title="Seconds after startup before switching accept throttles to steady-state (requires restart).">accept_steady_state_window {{template "restart-required" .}}</div>
						<input name="accept_steady_state_window" type="number" class="textfield" value="{{.Settings.AcceptSteadyStateWindow}}">
					</div>
					<div>
						<div class="label" title="Accepts/sec limit once steady-state mode activates (requires restart).">accept_steady_state_rate {{template "restart-required" .}}</div>
						<input name="accept_steady_state_rate" type="number" class="textfield" value="{{.Settings.AcceptSteadyStateRate}}">
					</div>
					<div>
						<div class="label" title="Expected % of miners reconnecting during normal operation (used for auto_accept_rate_limits; requires restart).">steady_state_reconnect_percent {{template "restart-required" .}}</div>
						<input name="accept_steady_state_reconnect_percent" type="text" class="textfield" value="{{printf "%.4f" .Settings.AcceptSteadyStateReconnectPercent}}">
					</div>
					<div>
						<div class="label" title="Seconds to spread expected steady-state reconnects across (used for auto_accept_rate_limits; requires restart).">steady_state_reconnect_window {{template "restart-required" .}}</div>
						<input name="accept_steady_state_reconnect_window" type="number" class="textfield" value="{{.Settings.AcceptSteadyStateReconnectWindow}}">
					</div>
				</div>

				<h3 style="margin:18px 0 8px 0;">Difficulty</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="Minimum VarDiff target difficulty for miner connections (0 uses defaults/auto; requires restart).">min_difficulty {{template "restart-required" .}}</div>
						<input name="min_difficulty" type="text" class="textfield" value="{{printf "%.8f" .Settings.MinDifficulty}}">
					</div>
					<div>
						<div class="label" title="Maximum VarDiff target difficulty for miner connections (0 uses defaults/auto; requires restart).">max_difficulty {{template "restart-required" .}}</div>
						<input name="max_difficulty" type="text" class="textfield" value="{{printf "%.8f" .Settings.MaxDifficulty}}">
					</div>
					<div>
						<div class="label" title="When enabled, the first mining.suggest_difficulty / mining.suggest_target locks that connection to the suggested difficulty (disables VarDiff; requires restart).">lock_suggested_difficulty {{template "restart-required" .}}</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="lock_suggested_difficulty" value="1" {{if .Settings.LockSuggestedDifficulty}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
				</div>

				<h3 style="margin:18px 0 8px 0;">Bans</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="When enabled, expired bans are removed from disk at startup (startup-only).">clean_expired_on_startup {{template "restart-required" .}}</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="clean_expired_on_startup" value="1" {{if .Settings.CleanExpiredBansOnStartup}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
					<div>
						<div class="label" title="Ban a worker after this many invalid submissions within the window (0 disables; requires restart).">ban_invalid_submissions_after {{template "restart-required" .}}</div>
						<input name="ban_invalid_submissions_after" type="number" class="textfield" value="{{.Settings.BanInvalidSubmissionsAfter}}">
					</div>
					<div>
						<div class="label" title="Window size (seconds) for invalid submission counting (requires restart).">ban_invalid_submissions_window_seconds {{template "restart-required" .}}</div>
						<input name="ban_invalid_submissions_window_seconds" type="number" class="textfield" value="{{.Settings.BanInvalidSubmissionsWindowSeconds}}">
					</div>
					<div>
						<div class="label" title="Ban duration (seconds) once the invalid threshold is hit (requires restart).">ban_invalid_submissions_duration_seconds {{template "restart-required" .}}</div>
						<input name="ban_invalid_submissions_duration_seconds" type="number" class="textfield" value="{{.Settings.BanInvalidSubmissionsDurationSeconds}}">
					</div>
					<div>
						<div class="label" title="Ban a host after this many reconnects within the window (0 disables; requires restart).">reconnect_ban_threshold {{template "restart-required" .}}</div>
						<input name="reconnect_ban_threshold" type="number" class="textfield" value="{{.Settings.ReconnectBanThreshold}}">
					</div>
					<div>
						<div class="label" title="Reconnect ban counting window (seconds; requires restart).">reconnect_ban_window_seconds {{template "restart-required" .}}</div>
						<input name="reconnect_ban_window_seconds" type="number" class="textfield" value="{{.Settings.ReconnectBanWindowSeconds}}">
					</div>
					<div>
						<div class="label" title="Reconnect ban duration (seconds) once threshold is hit (requires restart).">reconnect_ban_duration_seconds {{template "restart-required" .}}</div>
						<input name="reconnect_ban_duration_seconds" type="number" class="textfield" value="{{.Settings.ReconnectBanDurationSeconds}}">
					</div>
				</div>

				<h3 style="margin:18px 0 8px 0;">Peer cleaning</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="Enable best-effort pruning of high-latency peers (applies to node-info display and warnings).">peer_cleanup_enabled</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="peer_cleanup_enabled" value="1" {{if .Settings.PeerCleanupEnabled}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
					<div>
						<div class="label" title="Max peer ping (ms) above which peers are considered unhealthy.">peer_cleanup_max_ping_ms</div>
						<input name="peer_cleanup_max_ping_ms" type="text" class="textfield" value="{{printf "%.2f" .Settings.PeerCleanupMaxPingMs}}">
					</div>
					<div>
						<div class="label" title="Minimum number of peers to keep connected before pruning.">peer_cleanup_min_peers</div>
						<input name="peer_cleanup_min_peers" type="number" class="textfield" value="{{.Settings.PeerCleanupMinPeers}}">
					</div>
				</div>

				<h3 style="margin:18px 0 8px 0;">Other</h3>
				<div class="grid admin-grid">
					<div>
						<div class="label" title="Miner connection idle timeout (seconds; requires restart).">connection_timeout_seconds {{template "restart-required" .}}</div>
						<input name="connection_timeout_seconds" type="number" class="textfield" value="{{.Settings.ConnectionTimeoutSeconds}}">
					</div>
					<div>
						<div class="label" title="Logging verbosity for goPool (debug, info, warn, error; requires restart).">log_level {{template "restart-required" .}}</div>
						<input name="log_level" type="text" class="textfield" value="{{.Settings.LogLevel}}">
					</div>
					<div>
						<div class="label" title="Solo mode uses lighter submit validation (skips worker-mismatch + some policy checks; requires restart).">solo_mode {{template "restart-required" .}}</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="solo_mode" value="1" {{if .Settings.SoloMode}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
					<div>
						<div class="label" title="Process mining.submit on the connection goroutine (lower latency; can block reads; requires restart).">direct_submit_processing {{template "restart-required" .}}</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="direct_submit_processing" value="1" {{if .Settings.DirectSubmitProcessing}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
					<div>
						<div class="label" title="Enable duplicate share detection (keeps a per-connection cache; requires restart).">check_duplicate_shares {{template "restart-required" .}}</div>
						<label class="label" style="font-weight:500;margin-top:10px;">
							<input type="checkbox" name="check_duplicate_shares" value="1" {{if .Settings.CheckDuplicateShares}}checked{{end}}>
							<span style="margin-left:8px;">Enabled</span>
						</label>
					</div>
				</div>

				<label class="label" for="apply-password" style="margin-top:16px;">Admin password (required)</label>
				<p class="text-sm" style="margin:4px 0 0 0;color:rgba(255,255,255,0.72);">
					This confirms the change; it does not set or change your password.
				</p>
				<input id="apply-password" name="password" type="password" class="textfield" autocomplete="current-password" placeholder="Enter admin.toml password" required>
				<button class="btn" type="submit" style="margin-top:12px;">Apply live settings</button>
			</form>
		</div>

		<div class="card">
			<div class="label">Save to disk</div>
			<p class="text-sm" style="margin:4px 0 10px 0;">
				Force-write the current in-memory config to <span class="mono">config.toml</span> and <span class="mono">tuning.toml</span>.
				This overwrites files on disk; use with care.
			</p>
			{{if .AdminPersistError}}
			<p class="text-sm" style="color:#f88d8d;">{{.AdminPersistError}}</p>
			{{end}}
			<form method="post" action="/admin/persist">
				<label class="label" for="persist-password">Admin password (required)</label>
				<input id="persist-password" name="password" type="password" class="textfield" autocomplete="current-password" placeholder="Enter admin.toml password" required>
				<label class="label" for="persist-confirm">Confirmation</label>
				<input id="persist-confirm" name="confirm" type="text" class="textfield" placeholder="Type SAVE" required>
				<button class="btn btn-secondary" type="submit" style="margin-top:12px;">Save config.toml + tuning.toml</button>
			</form>
		</div>

		<div class="card">
			<div class="label">Reboot the pool</div>
			<p class="text-sm" style="margin:4px 0 10px 0;">This sends SIGTERM to goPool. Make sure your supervisor restarts it.</p>
			{{if .AdminRebootError}}
			<p class="text-sm" style="color:#f88d8d;">{{.AdminRebootError}}</p>
			{{end}}
			<form method="post" action="/admin/reboot">
				<label class="label" for="reboot-password">Admin password (required)</label>
				<input id="reboot-password" name="password" type="password" class="textfield" autocomplete="current-password" placeholder="Enter admin.toml password" required>
				<label class="label" for="reboot-confirm">Confirmation</label>
				<input id="reboot-confirm" name="confirm" type="text" class="textfield" placeholder="Type REBOOT" required>
				<button class="btn btn-secondary" type="submit" style="margin-top:12px;">Reboot now</button>
			</form>
		</div>

		<div class="card">
			<form method="post" action="/admin/logout">
				<button class="btn btn-secondary" type="submit">Sign out</button>
			</form>
		</div>
		{{end}}
	</div>
	{{template "footer" .}}
</body>
</html>
