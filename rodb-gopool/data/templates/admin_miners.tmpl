{{/* Admin connected miners page template */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} Admin Miners</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<div class="page admin-page">
		<h1>Admin Control Panel</h1>
		<p class="text-sm" style="margin-top:4px;">
			Inspect live miner connections and disconnect or ban them quickly. Select the rows you want to affect, enter the admin password once, and apply the action below.
		</p>
		{{if .AdminNotice}}
		<div class="card">
			<p class="text-sm">{{.AdminNotice}}</p>
		</div>
		{{end}}
		{{if not .AdminEnabled}}
		<div class="card">
			<p class="text-sm">
				The admin panel is disabled. Enable it by editing <span class="mono">{{.AdminConfigPath}}</span> and setting <span class="mono">enabled = true</span>.
			</p>
		</div>
		{{else if not .LoggedIn}}
		<div class="card">
			<p class="text-sm">
				Sign in on the <a href="/admin">main admin page</a> to view connected miners.
			</p>
		</div>
		{{else}}
		{{template "admin-nav" .}}
		<div class="card">
			<div class="label">Connected miners</div>
			<p class="text-sm" style="margin:4px 0 10px 0;">
				Select the connections you want to touch, then choose an action.
			</p>
			{{if .AdminMinerRows}}
			<div class="admin-toolbar">
				<div class="toolbar-left">
					<label class="label" for="miner-toolbar-password">Admin password</label>
					<input id="miner-toolbar-password" class="textfield toolbar-password" type="password" placeholder="Admin password">
				</div>
				<div class="toolbar-actions">
					<button class="btn btn-secondary" type="button" id="miner-toolbar-disconnect" disabled>Disconnect selected</button>
					<button class="btn btn-danger" type="button" id="miner-toolbar-ban" disabled>Ban selected</button>
				</div>
			</div>
			<form id="minerActionsForm" style="display:none;">
				<input type="hidden" name="password" id="minerToolbarPasswordField">
				<div id="minerToolbarConnections"></div>
			</form>
			<div class="admin-pagination">
				<div class="admin-pagination-summary text-sm">
					{{if gt .AdminMinerPagination.TotalItems 0}}
					Showing {{.AdminMinerPagination.RangeStart}} – {{.AdminMinerPagination.RangeEnd}} of {{.AdminMinerPagination.TotalItems}}
					{{else}}
					Showing 0 entries
					{{end}}
				</div>
				<form class="pagination-form" method="get" action="/admin/miners">
					<label for="miners-per-page">Items per page</label>
					<select id="miners-per-page" name="per_page" onchange="this.form.submit()">
						{{range $opt := .AdminPerPageOptions}}
						<option value="{{$opt}}" {{if eq $opt $.AdminMinerPagination.PerPage}}selected{{end}}>{{$opt}}</option>
						{{end}}
					</select>
					<input type="hidden" name="page" value="1">
				</form>
				<div class="pagination-links">
					{{if .AdminMinerPagination.HasPrevPage}}
					<a href="/admin/miners?page={{.AdminMinerPagination.PrevPage}}&per_page={{.AdminMinerPagination.PerPage}}">Previous</a>
					{{end}}
					{{if .AdminMinerPagination.HasNextPage}}
					<a href="/admin/miners?page={{.AdminMinerPagination.NextPage}}&per_page={{.AdminMinerPagination.PerPage}}">Next</a>
					{{end}}
				</div>
			</div>
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>ID</th>
							<th>Worker</th>
							<th>Remote</th>
							<th>Listener</th>
							<th>Difficulty</th>
							<th>Hashrate</th>
							<th>Accept/min</th>
							<th>Submit/min</th>
							<th>Connected</th>
							<th>Last share</th>
							<th>Status</th>
							<th>Select</th>
						</tr>
					</thead>
					<tbody>
						{{range .AdminMinerRows}}
						<tr>
							<td>{{shortID .ConnectionLabel}}</td>
							<td>
								<div>{{if .Worker}}{{.Worker}}{{else}}—{{end}}</div>
								{{if .WorkerHash}}<div class="mono" style="font-size:12px;">{{shortID .WorkerHash}}</div>{{end}}
								{{if .ClientName}}<div class="text-sm">{{.ClientName}}{{if .ClientVersion}} {{.ClientVersion}}{{end}}</div>{{end}}
							</td>
							<td>{{.RemoteAddr}}</td>
							<td>{{.Listener}}</td>
							<td>{{formatDiff .Difficulty}}</td>
							<td>{{formatHashrate .Hashrate}}</td>
							<td>{{printf "%.2f" .AcceptRatePerMinute}}</td>
							<td>{{printf "%.2f" .SubmitRatePerMinute}}</td>
							<td>{{formatTime .ConnectedAt}}</td>
							<td>{{formatTime .LastShare}}</td>
							<td>
								{{if .Banned}}
									<span class="badge badge-danger">Banned until {{formatTimeUTC .BanUntil}}</span>
									<div class="text-sm">{{.BanReason}}</div>
								{{else}}
									Active
								{{end}}
							</td>
							<td>
								<input type="checkbox" class="admin-row-checkbox" data-connection="{{.ConnectionSeq}}">
							</td>
						</tr>
						{{end}}
					</tbody>
				</table>
			</div>
			{{else}}
			<div class="table-responsive">
				<table class="table">
					<tr>
						<td colspan="12" class="text-sm">No miner connections detected.</td>
					</tr>
				</table>
			</div>
			{{end}}
		</div>
		{{end}}
	</div>
	{{template "footer" .}}
	<script>
	(function() {
		const form = document.getElementById('minerActionsForm');
		const passwordInput = document.getElementById('miner-toolbar-password');
		const passwordField = document.getElementById('minerToolbarPasswordField');
		const connectionsContainer = document.getElementById('minerToolbarConnections');
		const checkboxes = Array.from(document.querySelectorAll('.admin-row-checkbox'));
		const disconnectBtn = document.getElementById('miner-toolbar-disconnect');
		const banBtn = document.getElementById('miner-toolbar-ban');

		function updateButtons() {
			const selected = checkboxes.filter(cb => cb.checked);
			const enabled = selected.length > 0;
			disconnectBtn.disabled = !enabled;
			banBtn.disabled = !enabled;
			return selected;
		}

		function submitAction(action) {
			const selected = updateButtons();
			if (!selected.length) {
				return;
			}
			connectionsContainer.innerHTML = '';
			selected.forEach(cb => {
				const input = document.createElement('input');
				input.type = 'hidden';
				input.name = 'connection_seq';
				input.value = cb.dataset.connection || '';
				connectionsContainer.appendChild(input);
			});
			passwordField.value = passwordInput.value;
			form.action = action;
			form.submit();
		}

		checkboxes.forEach(cb => {
			cb.addEventListener('change', updateButtons);
		});
		disconnectBtn.addEventListener('click', () => submitAction('/admin/miners/disconnect'));
		banBtn.addEventListener('click', () => submitAction('/admin/miners/ban'));
	})();
	</script>
</body>
</html>
