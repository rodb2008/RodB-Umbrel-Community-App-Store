{{/* Worker status template (migrated from worker_status.html) */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} — Worker Info</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body{{if .PrivacyMode}} class="privacy-mode"{{end}}>
	{{template "header" .}}
	<main class="page" id="content">
		{{if .Error}}
			<div class="card">
				<p class="text-sm" style="color:#f88d8d;">{{.Error}}</p>
				<p class="text-sm" style="margin-top:10px;">
					<a href="/worker">← Back to Workers</a>
				</p>
			</div>
		{{else if .Worker}}
			<div class="card">
				<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
					<div style="flex:1;min-width:220px;">
						<p class="text-sm" style="margin:0 0 4px 0;">
							<strong>Privacy mode</strong>
							<span class="privacy-description">{{if .PrivacyMode}}is enabled and hides wallet addresses, hashes, and coinbase details by default.{{else}}is disabled and the full worker info is visible right now.{{end}}</span>
						</p>
						<p class="text-sm" style="color:#b3bbd4;margin:0;">
							This setting only applies to the current view and is not saved.
						</p>
					</div>
					<button id="privacyToggle" class="btn" type="button" data-privacy-mode="{{if .PrivacyMode}}on{{else}}off{{end}}">
						{{if .PrivacyMode}}Show wallet/hash details{{else}}Hide wallet/hash details{{end}}
					</button>
				</div>
			</div>
			<div class="card">
				<div class="grid">
					<div>
						<div class="label">Miner</div>
						<div class="value">
							{{if .Worker.MinerName}}
								<span class="mono">
									{{.Worker.MinerName}}{{if .Worker.MinerVersion}} {{.Worker.MinerVersion}}{{end}}
								</span>
							{{else if .Worker.MinerType}}
								<span class="mono">{{.Worker.MinerType}}</span>
							{{else}}
								—
							{{end}}
						</div>
					</div>
					<div>
						<div class="label">Hashrate</div>
						<div class="value">{{if .Worker.RollingHashrate}}{{formatHashrate .Worker.RollingHashrate}}{{else}}---{{end}}</div>
					</div>
					<div>
						<div class="label">Wallet checked</div>
						<div class="value">
							{{if .Worker.WalletValidated}}Yes{{else}}No{{end}}
						</div>
					</div>
					<div>
						<div class="label">Wallet result</div>
						<div class="value">
							{{if .Worker.WalletValidated}}
								Valid
							{{else}}
								Unknown
							{{end}}
						</div>
					</div>
					<div>
						<div class="label">Wallet address</div>
						<div class="value">
							{{if .Worker.WalletAddress}}
								<span class="code-box copyable sensitive-data" title="Click to copy wallet address" data-copy="{{.Worker.WalletAddress}}">{{.Worker.WalletAddress}}</span>
							{{else}}
								—
							{{end}}
						</div>
					</div>
					<div>
						<div class="label">Pending balance (BTC)</div>
						<div class="value">
							{{formatBTCShort .Worker.BalanceSats}}
						</div>
					</div>
					<div>
						<div class="label">Difficulty</div>
						<div class="value">{{formatDiff .Worker.Difficulty}}</div>
					</div>
					<div>
						<div class="label">Window acc/sub</div>
						<div class="value">{{.Worker.WindowAccepted}} / {{.Worker.WindowSubmissions}}</div>
					</div>
					<div>
						<div class="label">Shares/min</div>
						<div class="value">{{printf "%.1f" .Worker.ShareRate}}</div>
					</div>
					<div>
						<div class="label">Accepted</div>
						<div class="value">{{.Worker.Accepted}}</div>
					</div>
					<div>
						<div class="label">Rejected</div>
						<div class="value">{{.Worker.Rejected}}</div>
					</div>
					<div>
						<div class="label">Last share</div>
						<div class="value">{{formatTimeUTC .Worker.LastShare}}</div>
					</div>
					<div>
						<div class="label">Last share hash</div>
						<div class="value">
							{{if .Worker.LastShareHash}}
								<span class="code-box copyable sensitive-data" title="Click to copy last share hash" data-copy="{{.Worker.LastShareHash}}">{{.Worker.LastShareHash}}</span>
							{{else if .Worker.DisplayLastShare}}
								<span class="code-box copyable sensitive-data" title="Click to copy last share hash" data-copy="{{.Worker.DisplayLastShare}}">{{.Worker.DisplayLastShare}}</span>
							{{else}}
								—
							{{end}}
						</div>
					</div>
					<div>
						<div class="label">Ban status</div>
						<div class="value">
							{{if .Worker.Banned}}
								<span class="badge">Banned</span><br>
								<span class="label">Until</span> {{formatTime .Worker.BannedUntil}}<br>
								{{if .Worker.BanReason}}<span class="label">Reason</span> {{.Worker.BanReason}}{{end}}
							{{else}}
								—
							{{end}}
						</div>
					</div>
					<div>
						<div class="label">Last reject</div>
						<div class="value">
							{{if .Worker.LastReject}}
								<span class="badge">{{.Worker.LastReject}}</span>
							{{else}}
								—
							{{end}}
						</div>
					</div>
				</div>
			</div>
			<div class="card" style="margin-top:16px;">
				<div class="label">Last share / job details</div>
				{{if .Worker.LastShare.IsZero}}
					<p class="text-sm" style="margin-top:8px;">No shares recorded yet for this worker.</p>
				{{else}}
					<p class="text-sm" style="margin-top:8px;">
						Time: {{formatTimeUTC .Worker.LastShare}}<br>
						Status:
						{{if .Worker.LastShareAccepted}}
							Accepted
						{{else if .Worker.LastReject}}
							Rejected (reason: {{.Worker.LastReject}})
						{{else}}
							Unknown
						{{end}}<br>
						Difficulty:
						{{if gt .Worker.LastShareDifficulty 0.0}}
							{{printf "%.8f" .Worker.LastShareDifficulty}}
						{{else if gt .Worker.Difficulty 0.0}}
							{{printf "%.8f" .Worker.Difficulty}} (current target)
						{{else}}
							unknown
						{{end}}<br>
						Hash:
						{{if .Worker.LastShareHash}}
							<span class="code-box copyable sensitive-data" title="Click to copy last share hash" data-copy="{{.Worker.LastShareHash}}">{{.Worker.LastShareHash}}</span>
						{{else if .Worker.DisplayLastShare}}
							<span class="code-box copyable sensitive-data" title="Click to copy last share hash" data-copy="{{.Worker.DisplayLastShare}}">{{.Worker.DisplayLastShare}}</span>
					{{else}}
							unknown
						{{end}}
					</p>
				{{end}}
			</div>
			<div class="card" style="margin-top:16px;">
				<div class="label">Current job coinbase</div>
				{{if .CurrentJobCoinbase}}
					<p class="text-sm" style="margin-top:8px;">
						Height: {{if gt .CurrentJobHeight 0}}{{.CurrentJobHeight}}{{else}}unknown{{end}}<br>
						{{if .CurrentJobPrevHash}}
							Prevhash: <span class="code-box copyable sensitive-data" title="Click to copy prevhash" data-copy="{{.CurrentJobPrevHash}}">{{.CurrentJobPrevHash}}</span><br>
						{{end}}
						{{if .CurrentJobID}}
							Job ID: <span class="mono">{{.CurrentJobID}}</span>
						{{end}}
					</p>
					{{$root := .}}
					{{with .CurrentJobCoinbase}}
						<p class="text-sm" style="margin-top:4px;color:#b3bbd4;">
							This coinbase is constructed directly from the current stratum job (coinb1/coinb2) for this worker. Extranonce values are zeroed for display; coinbase outputs are identical to what miners receive.
						</p>
						{{if .Coinbase}}
							<p class="text-sm">
								<span class="mono">
									<a href="https://www.blockchain.com/explorer/assets/btc/decode-transaction" target="_blank" rel="noreferrer" title="Open decode tool; paste this coinbase hex there">
										coinbase_tx (hex):
									</a>
								</span><br>
								<span class="code-box copyable sensitive-data" title="Click to copy coinbase hex" data-copy="{{.Coinbase}}">{{.Coinbase}}</span>
							</p>
						{{end}}
						{{if or .CoinbaseVersion .CoinbaseLockTime .CoinbaseHeight .CoinbaseOutputs}}
							<h2 style="margin-top:16px;margin-bottom:6px;font-size:14px;">Decoded coinbase</h2>
							<p class="text-sm">
								Version: {{if .CoinbaseVersion}}{{.CoinbaseVersion}}{{else}}unknown{{end}}<br>
								Locktime: {{if .CoinbaseLockTime}}{{.CoinbaseLockTime}}{{else}}0{{end}}<br>
								Block height (BIP34): {{if .CoinbaseHeight}}{{.CoinbaseHeight}}{{else}}unknown{{end}}
							</p>
							{{if .TotalCoinbaseValue}}
								<p class="text-sm" style="margin-top:12px;">
									<strong>Total coinbase value:</strong> {{formatBTCShort .TotalCoinbaseValue}}{{if gt $root.BTCPriceFiat 0.0}} ({{formatFiat .TotalCoinbaseValue $root.BTCPriceFiat $root.FiatCurrency}}){{end}}
									{{if and .BlockSubsidy (gt .BlockSubsidy 0)}}
										<br><span style="color:#b3bbd4;">Block subsidy: {{formatBTCShort .BlockSubsidy}}{{if .TransactionFees}} + Transaction fees: {{formatBTCShort .TransactionFees}}{{end}}</span>
									{{end}}
								</p>
							{{end}}
							{{if .CoinbaseOutputs}}
								<div style="overflow-x:auto;margin-top:8px;">
									<table class="table">
										<thead>
											<tr>
												<th>Output #</th>
												<th>Role</th>
												<th>Value (BTC)</th>
												<th>Value (fiat)</th>
												<th>% of coinbase</th>
												<th>Address</th>
												<th>scriptPubKey (hex)</th>
											</tr>
										</thead>
										<tbody>
											{{range $i, $o := .CoinbaseOutputs}}
												<tr>
													<td>{{$i}}</td>
													<td>
														{{if and $root.WorkerScriptHex (eq $o.ScriptHex $root.WorkerScriptHex)}}
															Miner reward
														{{else if and $root.PoolScriptHex (eq $o.ScriptHex $root.PoolScriptHex)}}
															Pool fee
														{{else if and $root.DonationScriptHex (eq $o.ScriptHex $root.DonationScriptHex)}}
															{{if $root.OperatorDonationName}}
																Pool donation to {{$root.OperatorDonationName}}
															{{else}}
																Pool donation
															{{end}}
														{{else if and (eq $i 0) (eq $o.ValueSats 0)}}
															Witness commitment
														{{else if $o.Address}}
															Coinbase output ({{$o.Address}})
														{{else}}
															Other coinbase output
														{{end}}
													</td>
													<td>{{formatBTCShort $o.ValueSats}}</td>
													<td>
														{{if gt $root.BTCPriceFiat 0.0}}
															{{formatFiat $o.ValueSats $root.BTCPriceFiat $root.FiatCurrency}}
														{{else}}
															—
														{{end}}
													</td>
													<td>{{printf "%.4f%%" $o.Percent}}</td>
													<td>
														{{if and $root.WorkerScriptHex (eq $o.ScriptHex $root.WorkerScriptHex) $root.Worker.WalletAddress}}<span class="mono sensitive-data"><a href="https://mempool.space/address/{{$root.Worker.WalletAddress}}" target="_blank" rel="noreferrer" title="View {{$root.Worker.WalletAddress}} on mempool.space">{{$root.Worker.WalletAddress}}</a></span>{{else if and $root.PoolScriptHex (eq $o.ScriptHex $root.PoolScriptHex) $root.PayoutAddress}}<span class="mono sensitive-data"><a href="https://mempool.space/address/{{$root.PayoutAddress}}" target="_blank" rel="noreferrer" title="View {{$root.PayoutAddress}} on mempool.space">{{$root.PayoutAddress}}</a></span>{{else if and $root.DonationScriptHex (eq $o.ScriptHex $root.DonationScriptHex) $root.OperatorDonationAddress}}<span class="mono sensitive-data"><a href="https://mempool.space/address/{{$root.OperatorDonationAddress}}" target="_blank" rel="noreferrer" title="View {{$root.OperatorDonationAddress}} on mempool.space">{{$root.OperatorDonationAddress}}</a></span>{{else if $o.Address}}<span class="mono sensitive-data"><a href="https://mempool.space/address/{{$o.Address}}" target="_blank" rel="noreferrer" title="View {{$o.Address}} on mempool.space">{{$o.Address}}</a></span>{{else}}—{{end}}
													</td>
													<td>
														<span class="code-box copyable sensitive-data" title="Click to copy scriptPubKey hex" data-copy="{{$o.ScriptHex}}">{{$o.ScriptHex}}</span>
													</td>
												</tr>
											{{end}}
										</tbody>
									</table>
								</div>
								{{if $root.FiatNote}}
									<p class="text-sm" style="margin-top:8px;color:#b3bbd4;">
										{{$root.FiatNote}}
									</p>
								{{end}}
							{{end}}
						{{end}}
					{{end}}
				{{else}}
					<p class="text-sm" style="margin-top:8px;">No active job available.</p>
				{{end}}
			</div>
		{{else}}
			<div class="card">
				<p class="text-sm">No worker found.</p>
				<p class="text-sm" style="margin-top:10px;">
					<a href="/worker">← Back to Workers</a>
				</p>
			</div>
		{{end}}

		{{template "footer" .}}
	</main>
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const toggle = document.getElementById('privacyToggle');
		if (!toggle) {
			return;
		}

		// Censor a string by keeping first 8 and last 8 chars with ".." in between
		function censorString(s) {
			if (!s || s.length <= 16) return s;
			// Handle already-censored strings that start with ".."
			if (s.startsWith('..')) {
				s = s.substring(2).trim();
			}
			return s.substring(0, 8) + '..' + s.substring(s.length - 8);
		}

		// Store original values for each sensitive element
		const sensitiveElements = document.querySelectorAll('.sensitive-data');
		const originalValues = new Map();

		sensitiveElements.forEach(el => {
			// Store original text content
			let originalText = '';
			const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
			if (textNode) {
				originalText = textNode.textContent.trim();
			} else {
				// Handle case where text is in a child element (like <a>)
				const link = el.querySelector('a');
				if (link) {
					originalText = link.textContent.trim();
				} else {
					originalText = el.textContent.trim();
				}
			}

			// Clean up server-side censored values that might be cached (starts with "..")
			if (originalText.startsWith('..')) {
				originalText = originalText.substring(2).trim();
			}

			originalValues.set(el, originalText);
		});

		// Apply initial privacy state
		if (document.body.classList.contains('privacy-mode')) {
			sensitiveElements.forEach(el => {
				const original = originalValues.get(el);
				if (original) {
					const censored = censorString(original);
					const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
					if (textNode) {
						textNode.textContent = censored;
					} else {
						const link = el.querySelector('a');
						if (link) {
							link.textContent = censored;
						} else {
							el.textContent = censored;
						}
					}
				}
			});
		}

		toggle.addEventListener('click', () => {
			const isPrivate = document.body.classList.toggle('privacy-mode');
			toggle.dataset.privacyMode = isPrivate ? 'on' : 'off';
			toggle.textContent = isPrivate ? 'Show wallet/hash details' : 'Hide wallet/hash details';

			// Update privacy mode description
			const desc = document.querySelector('.privacy-description');
			if (desc) {
				desc.textContent = isPrivate
					? 'is enabled and hides wallet addresses, hashes, and coinbase details by default.'
					: 'is disabled and the full worker info is visible right now.';
			}

			// Toggle censoring on all sensitive elements
			sensitiveElements.forEach(el => {
				const original = originalValues.get(el);
				if (original) {
					const newText = isPrivate ? censorString(original) : original;
					const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
					if (textNode) {
						textNode.textContent = newText;
					} else {
						const link = el.querySelector('a');
						if (link) {
							link.textContent = newText;
						} else {
							el.textContent = newText;
						}
					}
				}
			});
		});
	});
	</script>
</body>
</html>
