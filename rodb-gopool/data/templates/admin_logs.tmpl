{{/* Admin logs page template */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} - Admin Logs</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<main class="page admin-page" id="content">
		<h1>Admin Control Panel</h1>
		<p class="text-sm" style="margin-top:4px;">
			Live tail view of pool logs for troubleshooting. This view auto-refreshes while the page is open.
		</p>
		{{if .AdminNotice}}
		<div class="card">
			<p class="text-sm">{{.AdminNotice}}</p>
		</div>
		{{end}}
		{{if not .AdminEnabled}}
		<div class="card">
			<p class="text-sm">
				The admin panel is disabled. Enable it by editing <span class="mono">{{.AdminConfigPath}}</span> and setting <span class="mono">enabled = true</span>.
			</p>
		</div>
		{{else if not .LoggedIn}}
		<div class="card">
			<p class="text-sm">
				Sign in on the <a href="/admin">main admin page</a> to view logs.
			</p>
		</div>
		{{else}}
		{{template "admin-nav" .}}
			<div class="card">
				<div style="display:flex;align-items:end;gap:12px;flex-wrap:wrap;">
						<div>
							<div class="label">Log source</div>
						<select id="admin-log-source" class="textfield" style="min-width:220px;">
							<option value="pool" {{if eq .AdminLogSource "pool"}}selected{{end}}>Pool</option>
							<option value="debug" {{if eq .AdminLogSource "debug"}}selected{{end}}>Debug</option>
							<option value="net" {{if eq .AdminLogSource "net"}}selected{{end}}>Network Debug</option>
						</select>
					</div>
					<div>
						<div class="label">Refresh interval</div>
					<select id="admin-log-refresh" class="textfield" style="min-width:140px;">
						<option value="1000">1s</option>
						<option value="2000" selected>2s</option>
						<option value="5000">5s</option>
						<option value="10000">10s</option>
					</select>
					</div>
						<div>
							<div class="label">Logging flags</div>
							<label style="display:flex;align-items:center;gap:8px;">
								<input id="admin-log-flag-debug" type="checkbox" {{if .AdminDebugEnabled}}checked{{end}}>
								<span class="text-sm">Debug</span>
							</label>
							<label style="display:flex;align-items:center;gap:8px;margin-top:6px;{{if not .AdminNetDebugSupport}}opacity:.65;{{end}}">
								<input id="admin-log-flag-net-debug" type="checkbox" {{if .AdminNetDebugEnabled}}checked{{end}} {{if not .AdminNetDebugSupport}}disabled{{end}}>
								<span class="text-sm">Net Debug{{if not .AdminNetDebugSupport}} (debug build only){{end}}</span>
							</label>
						</div>
						<div>
							<div class="label">Admin password</div>
							<input id="admin-log-flags-password" type="password" class="textfield" placeholder="Admin password" style="min-width:220px;">
						</div>
						<button id="admin-log-flags-apply" class="btn btn-secondary" type="button">Apply logging flags</button>
						<button id="admin-log-refresh-now" class="btn btn-secondary" type="button">Refresh now</button>
					</div>
				<div id="admin-log-notice" class="text-sm" style="display:none;margin:10px 0 0 0;padding:10px 12px;border-radius:10px;border:1px solid #3a4252;background:#131923;color:#dbe6ff;"></div>
				<p class="text-sm" id="admin-log-meta" style="margin:10px 0 0 0;color:var(--text-muted);"></p>
			<pre id="admin-log-output" class="mono" style="margin-top:12px;max-height:65vh;overflow:auto;background:#0b0d12;border:1px solid #2a2f3a;padding:12px;border-radius:10px;white-space:pre-wrap;word-break:break-word;"></pre>
		</div>
		{{end}}
	{{template "footer" .}}
	</main>
	<script>
	(function() {
		const sourceSel = document.getElementById('admin-log-source');
		const refreshSel = document.getElementById('admin-log-refresh');
		const refreshBtn = document.getElementById('admin-log-refresh-now');
			const debugChk = document.getElementById('admin-log-flag-debug');
			const netDebugChk = document.getElementById('admin-log-flag-net-debug');
			const flagsPass = document.getElementById('admin-log-flags-password');
			const flagsApplyBtn = document.getElementById('admin-log-flags-apply');
		const outEl = document.getElementById('admin-log-output');
		const metaEl = document.getElementById('admin-log-meta');
		const noticeEl = document.getElementById('admin-log-notice');
		if (!sourceSel || !refreshSel || !outEl || !metaEl || !noticeEl) return;

		let timer = null;
		let pending = false;
		let lastText = '';
		let tailMetaText = '';
		let noticeText = '';
		let noticeKind = 'info';
		let noticeTimer = null;

		function setMeta(text) {
			tailMetaText = text || '';
			metaEl.textContent = tailMetaText;
		}

		function setNotice(text, ms, kind) {
			noticeText = text || '';
			noticeKind = kind || 'info';
			if (noticeTimer) clearTimeout(noticeTimer);
			noticeTimer = null;
			if (noticeText) {
				let border = '#3a4252';
				let bg = '#131923';
				let fg = '#dbe6ff';
				if (noticeKind === 'error') {
					border = '#6a2a33';
					bg = '#241317';
					fg = '#ffd7dc';
				} else if (noticeKind === 'success') {
					border = '#24563a';
					bg = '#112018';
					fg = '#d7ffe6';
				}
				noticeEl.style.display = 'block';
				noticeEl.style.borderColor = border;
				noticeEl.style.background = bg;
				noticeEl.style.color = fg;
				noticeEl.textContent = noticeText;
			} else {
				noticeEl.textContent = '';
				noticeEl.style.display = 'none';
			}
			if (noticeText && ms > 0) {
				noticeTimer = setTimeout(() => {
					noticeText = '';
					noticeTimer = null;
					noticeEl.textContent = '';
					noticeEl.style.display = 'none';
				}, ms);
			}
		}

		async function fetchLogs() {
			if (pending) return;
			pending = true;
			try {
				const source = encodeURIComponent(sourceSel.value || 'pool');
				const res = await fetch(`/admin/logs/tail?source=${source}`, { credentials: 'same-origin' });
				if (!res.ok) {
					setNotice(`Failed to load logs (${res.status}).`, 8000, 'error');
					return;
				}
				const data = await res.json();
				const lines = Array.isArray(data.lines) ? data.lines : [];
				const text = lines.join('\n');
				if (text !== lastText) {
					lastText = text;
					const atBottom = outEl.scrollTop + outEl.clientHeight >= outEl.scrollHeight - 8;
					outEl.textContent = text || 'No log lines available.';
					if (atBottom) {
						outEl.scrollTop = outEl.scrollHeight;
					}
				}
				const parts = [];
				if (data.file) parts.push(`file: ${data.file}`);
				if (data.last_modified) parts.push(`updated: ${data.last_modified}`);
				if (data.truncated) parts.push('showing tail only');
				setMeta(parts.join(' | '));
			} catch (_) {
				setNotice('Failed to load logs.', 8000, 'error');
			} finally {
				pending = false;
			}
		}

		function restartTimer() {
			if (timer) clearInterval(timer);
			const ms = Math.max(1000, Number(refreshSel.value || 2000));
			timer = setInterval(fetchLogs, ms);
		}

		sourceSel.addEventListener('change', () => {
			lastText = '';
			fetchLogs();
		});
		refreshSel.addEventListener('change', restartTimer);
		if (refreshBtn) refreshBtn.addEventListener('click', fetchLogs);
			if (flagsApplyBtn && debugChk && netDebugChk && flagsPass) {
				flagsApplyBtn.addEventListener('click', async () => {
					const debug = !!debugChk.checked;
					const netDebug = !!netDebugChk.checked;
					const password = String(flagsPass.value || '');
					if (!password) {
						setNotice('Admin password is required to change logging flags.', 10000, 'error');
						return;
					}
					flagsApplyBtn.disabled = true;
					try {
						const body = new URLSearchParams();
						body.set('debug', debug ? '1' : '0');
						body.set('net_debug', netDebug ? '1' : '0');
						body.set('password', password);
						const res = await fetch('/admin/logs/flags', {
							method: 'POST',
							credentials: 'same-origin',
							headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: body.toString(),
					});
						if (!res.ok) {
							let detail = '';
							try {
								detail = String((await res.text()) || '').trim();
							} catch (_) {}
							if (detail) {
								setNotice(`Failed to update logging flags (${res.status}): ${detail}`, 12000, 'error');
							} else {
								setNotice(`Failed to update logging flags (${res.status}).`, 12000, 'error');
							}
							return;
						}
						const data = await res.json().catch(() => ({}));
						if (data && typeof data.debug === 'boolean') debugChk.checked = data.debug;
						if (data && typeof data.net_debug === 'boolean' && netDebugChk) netDebugChk.checked = data.net_debug;
						if (data && data.error) {
							setNotice(String(data.error), 12000, 'error');
						} else {
							setNotice(`Logging flags updated: debug=${debugChk.checked ? 'on' : 'off'}, net-debug=${netDebugChk.checked ? 'on' : 'off'}.`, 8000, 'success');
						}
						flagsPass.value = '';
						// Do not treat a follow-up refresh failure as a logging-flags failure.
						fetchLogs();
					} catch (err) {
						const msg = err && err.message ? String(err.message) : 'unknown error';
						setNotice(`Failed to update logging flags: ${msg}`, 12000, 'error');
					} finally {
						flagsApplyBtn.disabled = false;
					}
				});
			}

		restartTimer();
		fetchLogs();
	})();
	</script>
</body>
</html>
