{{/* Admin logs page template */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} â€” Admin Logs</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<main class="page admin-page" id="content">
		<h1>Admin Control Panel</h1>
		<p class="text-sm" style="margin-top:4px;">
			Live tail view of pool logs for troubleshooting. This view auto-refreshes while the page is open.
		</p>
		{{if .AdminNotice}}
		<div class="card">
			<p class="text-sm">{{.AdminNotice}}</p>
		</div>
		{{end}}
		{{if not .AdminEnabled}}
		<div class="card">
			<p class="text-sm">
				The admin panel is disabled. Enable it by editing <span class="mono">{{.AdminConfigPath}}</span> and setting <span class="mono">enabled = true</span>.
			</p>
		</div>
		{{else if not .LoggedIn}}
		<div class="card">
			<p class="text-sm">
				Sign in on the <a href="/admin">main admin page</a> to view logs.
			</p>
		</div>
		{{else}}
		{{template "admin-nav" .}}
			<div class="card">
				<div style="display:flex;align-items:end;gap:12px;flex-wrap:wrap;">
					<div>
						<div class="label">Log source</div>
					<select id="admin-log-source" class="textfield" style="min-width:220px;">
						<option value="pool" {{if eq .AdminLogSource "pool"}}selected{{end}}>Pool</option>
						<option value="errors" {{if eq .AdminLogSource "errors"}}selected{{end}}>Errors</option>
						<option value="debug" {{if eq .AdminLogSource "debug"}}selected{{end}}>Debug</option>
						<option value="net" {{if eq .AdminLogSource "net"}}selected{{end}}>Network Debug</option>
					</select>
				</div>
					<div>
						<div class="label">Refresh interval</div>
					<select id="admin-log-refresh" class="textfield" style="min-width:140px;">
						<option value="1000">1s</option>
						<option value="2000" selected>2s</option>
						<option value="5000">5s</option>
						<option value="10000">10s</option>
					</select>
					</div>
					<div>
						<div class="label">Log level</div>
						<select id="admin-log-level" class="textfield" style="min-width:140px;">
							<option value="debug" {{if eq .Settings.LogLevel "debug"}}selected{{end}}>debug</option>
							<option value="info" {{if eq .Settings.LogLevel "info"}}selected{{end}}>info</option>
							<option value="warn" {{if or (eq .Settings.LogLevel "warn") (eq .Settings.LogLevel "")}}selected{{end}}>warn</option>
							<option value="error" {{if eq .Settings.LogLevel "error"}}selected{{end}}>error</option>
						</select>
					</div>
					<div>
						<div class="label">Admin password</div>
						<input id="admin-log-level-password" type="password" class="textfield" placeholder="Admin password" style="min-width:220px;">
					</div>
					<button id="admin-log-level-apply" class="btn btn-secondary" type="button">Apply log level</button>
					<button id="admin-log-refresh-now" class="btn btn-secondary" type="button">Refresh now</button>
				</div>
				<p class="text-sm" id="admin-log-meta" style="margin:10px 0 0 0;color:var(--text-muted);"></p>
			<pre id="admin-log-output" class="mono" style="margin-top:12px;max-height:65vh;overflow:auto;background:#0b0d12;border:1px solid #2a2f3a;padding:12px;border-radius:10px;white-space:pre-wrap;word-break:break-word;"></pre>
		</div>
		{{end}}
	{{template "footer" .}}
	</main>
	<script>
	(function() {
		const sourceSel = document.getElementById('admin-log-source');
		const refreshSel = document.getElementById('admin-log-refresh');
		const refreshBtn = document.getElementById('admin-log-refresh-now');
		const levelSel = document.getElementById('admin-log-level');
		const levelPass = document.getElementById('admin-log-level-password');
		const levelApplyBtn = document.getElementById('admin-log-level-apply');
		const outEl = document.getElementById('admin-log-output');
		const metaEl = document.getElementById('admin-log-meta');
		if (!sourceSel || !refreshSel || !outEl || !metaEl) return;

		let timer = null;
		let pending = false;
		let lastText = '';

		function setMeta(text) {
			metaEl.textContent = text || '';
		}

		async function fetchLogs() {
			if (pending) return;
			pending = true;
			try {
				const source = encodeURIComponent(sourceSel.value || 'pool');
				const res = await fetch(`/admin/logs/tail?source=${source}`, { credentials: 'same-origin' });
				if (!res.ok) {
					setMeta(`Failed to load logs (${res.status}).`);
					return;
				}
				const data = await res.json();
				const lines = Array.isArray(data.lines) ? data.lines : [];
				const text = lines.join('\n');
				if (text !== lastText) {
					lastText = text;
					const atBottom = outEl.scrollTop + outEl.clientHeight >= outEl.scrollHeight - 8;
					outEl.textContent = text || 'No log lines available.';
					if (atBottom) {
						outEl.scrollTop = outEl.scrollHeight;
					}
				}
				const parts = [];
				if (data.file) parts.push(`file: ${data.file}`);
				if (data.last_modified) parts.push(`updated: ${data.last_modified}`);
				if (data.truncated) parts.push('showing tail only');
				setMeta(parts.join(' | '));
			} catch (_) {
				setMeta('Failed to load logs.');
			} finally {
				pending = false;
			}
		}

		function restartTimer() {
			if (timer) clearInterval(timer);
			const ms = Math.max(1000, Number(refreshSel.value || 2000));
			timer = setInterval(fetchLogs, ms);
		}

		sourceSel.addEventListener('change', () => {
			lastText = '';
			fetchLogs();
		});
		refreshSel.addEventListener('change', restartTimer);
		if (refreshBtn) refreshBtn.addEventListener('click', fetchLogs);
		if (levelApplyBtn && levelSel && levelPass) {
			levelApplyBtn.addEventListener('click', async () => {
				const level = String(levelSel.value || '').trim();
				const password = String(levelPass.value || '');
				if (!level) {
					setMeta('Choose a log level.');
					return;
				}
				if (!password) {
					setMeta('Admin password is required to change log level.');
					return;
				}
				levelApplyBtn.disabled = true;
				try {
					const body = new URLSearchParams();
					body.set('log_level', level);
					body.set('password', password);
					const res = await fetch('/admin/logs/log-level', {
						method: 'POST',
						credentials: 'same-origin',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: body.toString(),
					});
					if (!res.ok) {
						setMeta(`Failed to update log level (${res.status}).`);
						return;
					}
					setMeta(`Log level updated to ${level}.`);
					levelPass.value = '';
					await fetchLogs();
				} catch (_) {
					setMeta('Failed to update log level.');
				} finally {
					levelApplyBtn.disabled = false;
				}
			});
		}

		restartTimer();
		fetchLogs();
	})();
	</script>
</body>
</html>
