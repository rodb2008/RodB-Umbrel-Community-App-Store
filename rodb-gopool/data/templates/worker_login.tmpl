{{/* Worker login template */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} â€” Workers</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<main class="page" id="content">
		{{if .ClerkEnabled}}
		<div class="card login-card">
			<div class="login-card-header">
				<span class="login-card-badge">New Feature!</span>
				<h2>Personal Worker Dashboard</h2>
			</div>
			<p class="text-sm login-card-description">
				Sign in with Google to unlock a dedicated dashboard for all your workers!
			</p>
			<a class="btn btn-highlight" href="/sign-in?redirect=/saved-workers">Sign in</a>
		</div>
		{{end}}
		<div class="card worker-lookup-card">
			<div class="lookup-card-header">
				<h2>Quick Worker & Wallet Lookup</h2>
				<p class="text-sm lookup-card-description">
					Enter a wallet.worker-name to view worker stats or a wallet address to list every active worker mining to it.
				</p>
			</div>
			<form method="get" action="/worker/sha256" id="workerLookupForm">
				<label class="label" for="workerInput">Worker ID</label>
				<div class="input-row">
					<input class="input" type="text" id="workerInput" name="worker" placeholder="wallet.worker" autocomplete="off" spellcheck="false" required>
					<input type="hidden" name="hash" id="workerHash">
					<button class="btn" type="submit">Search worker</button>
				</div>
				<p class="text-sm lookup-card-footnote">
					Use the exact <span class="mono">wallet.worker</span> from your miner config.
				</p>
			</form>
			<hr style="margin:24px 0;border-top:1px solid var(--card-border);">
			<form method="get" action="/worker/search" id="walletLookupForm">
				<label class="label" for="walletInput">Wallet address</label>
				<div class="input-row">
					<input class="input" type="text" id="walletInput" name="wallet" placeholder="bc1..." autocomplete="off" spellcheck="false" required>
					<input type="hidden" name="hash" id="walletHash">
					<button class="btn" type="submit">Search wallet</button>
				</div>
			</form>
			<noscript>
				<p class="text-sm lookup-card-footnote" style="color:var(--text-muted); margin-top:10px;">
					Note: without JavaScript, your input will appear in the URL.
				</p>
			</noscript>
			{{if .Error}}
				<p class="text-sm" style="color:#f88d8d; margin-top:10px;">{{.Error}}</p>
			{{end}}
		</div>

		{{template "footer" .}}
	</main>
	<script src="/sha256.js"></script>
	<script>
	function isSHA256Hex(str) {
		return /^[a-f0-9]{64}$/i.test((str || '').trim());
	}

	async function sha256Always(str) {
		if (typeof window.sha256Hex !== 'function') return null;
		try { return await window.sha256Hex(str); } catch (_) { return null; }
	}

	async function submitWithOptionalHashing(form, inputEl, hashEl, emptyMessage) {
		const value = (inputEl?.value || '').trim();
		if (!value) {
			alert(emptyMessage);
			return;
		}
		inputEl.setAttribute('name', inputEl.id === 'walletInput' ? 'wallet' : 'worker');
		hashEl.value = '';

		if (isSHA256Hex(value)) {
			hashEl.value = value.toLowerCase();
			inputEl.removeAttribute('name');
			form.submit();
			return;
		}

		const hash = await sha256Always(value);
		if (hash) {
			hashEl.value = hash;
			inputEl.removeAttribute('name');
		}
		form.submit();
	}

	// Handle worker lookup form submission
	document.getElementById('workerLookupForm').addEventListener('submit', async function(e) {
		e.preventDefault();
		try {
			await submitWithOptionalHashing(this, document.getElementById('workerInput'), document.getElementById('workerHash'), 'Please enter a worker ID or worker hash');
		} catch (_) {
			this.submit();
		}
	});

	document.getElementById('walletLookupForm').addEventListener('submit', async function(e) {
		e.preventDefault();
		try {
			await submitWithOptionalHashing(this, document.getElementById('walletInput'), document.getElementById('walletHash'), 'Please enter a wallet address or wallet hash');
		} catch (_) {
			this.submit();
		}
	});
	</script>
</body>
</html>
