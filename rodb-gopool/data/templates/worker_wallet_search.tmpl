{{/* Worker wallet search template */}}
<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="64x64" href="/favicon.png">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{if .BrandDomain}}{{.BrandDomain}}{{else}}{{.BrandName}}{{end}} — Wallet Search</title>
	<link rel="stylesheet" href="/style.css">
</head>
<body>
	{{template "header" .}}
	<main class="page" id="content">
			<noscript>
				<div class="card">
					<p class="text-sm" style="color:#f88d8d;margin:0;">
						JavaScript is optional, but without it your wallet address will be sent in the URL.
					</p>
				</div>
			</noscript>
			<div class="card worker-search-card">
				<div class="lookup-card-header">
					<h2>Wallet search</h2>
					<p class="text-sm lookup-card-description">
						Enter your payout wallet address to list any currently connected workers that are using it.
					</p>
				</div>
				<form method="get" action="/worker/search" id="walletSearchForm">
					<label class="label" for="walletInput">Wallet address</label>
					<div class="input-row">
						<input class="input" type="text" id="walletInput" name="wallet" placeholder="bc1..." autocomplete="off" spellcheck="false" required>
						<input type="hidden" name="hash" id="walletHash">
						<button class="btn" type="submit">Search wallet</button>
					</div>
				</form>
				{{if .Error}}
					<p class="text-sm" style="color:#f88d8d; margin-top:10px;">{{.Error}}</p>
				{{else if .QueriedWalletHash}}
					<p class="text-sm" style="margin-top:10px; color:#b3bbd4;">
						Showing active workers for this wallet.
					</p>
				{{end}}
			</div>

		{{if gt (len .Results) 0}}
			<div class="card" style="margin-top:16px;">
				<table class="table">
					<thead>
						<tr>
							<th>Worker</th>
							<th>Hashrate</th>
							<th>Shares/min</th>
							<th>Current diff</th>
							<th>Connected</th>
							<th>Last share</th>
							<th>Accepted</th>
							<th>Rejected</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						{{range .Results}}
							<tr>
								<td>
									<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
										<a class="mono sensitive-worker worker-link" href="/worker/sha256?hash={{.WorkerSHA256}}">{{.DisplayName}}</a>
									</div>
								</td>
								<td>{{if gt .RollingHashrate 0.0}}{{formatHashrate .RollingHashrate}}{{else}}—{{end}}</td>
								<td>{{formatShareRate .ShareRate}}</td>
								<td>{{formatDiff .Difficulty}}</td>
								<td>{{formatTime .ConnectedAt}}</td>
								<td>{{formatTime .LastShare}}</td>
								<td>{{.Accepted}}</td>
								<td>{{.Rejected}}</td>
								<td>
									<a class="btn" href="/worker/sha256?hash={{.WorkerSHA256}}">View</a>
								</td>
							</tr>
						{{end}}
					</tbody>
				</table>
			</div>
		{{end}}

		<div class="card" style="margin-top:16px;">
			<p class="text-sm" style="margin:0;">
				<a href="/worker">← Back to Workers</a>
			</p>
		</div>
		{{template "footer" .}}
	</main>
	<script src="/sha256.js"></script>
	<script>
	function isSHA256Hex(str) {
		return /^[a-f0-9]{64}$/i.test((str || '').trim());
	}

	async function sha256Always(str) {
		if (typeof window.sha256Hex !== 'function') return null;
		try { return await window.sha256Hex(str); } catch (_) { return null; }
	}

	document.getElementById('walletSearchForm').addEventListener('submit', async function(e) {
		e.preventDefault();
		const walletEl = document.getElementById('walletInput');
		const hashEl = document.getElementById('walletHash');
		const walletInput = (walletEl?.value || '').trim();
		if (!walletInput) {
			alert('Please enter a wallet address or wallet hash');
			return;
		}
		try {
			walletEl.setAttribute('name', 'wallet');
			hashEl.value = '';

			// If the user already pasted a SHA256, just submit it.
			if (isSHA256Hex(walletInput)) {
				hashEl.value = walletInput.toLowerCase();
				walletEl.removeAttribute('name');
				this.submit();
				return;
			}

			// Hash client-side (works on HTTP via /sha256.js fallback); otherwise submit wallet and let server hash it.
			const hash = await sha256Always(walletInput);
			if (hash) {
				hashEl.value = hash;
				walletEl.removeAttribute('name');
			}
			this.submit();
		} catch (_) {
			// Best-effort fallback: submit wallet value, server will hash.
			this.submit();
		}
	});
	</script>
</body>
</html>
